//v1.0.0
(function(t,q){function h(a,b){r(a)?this.form=a:"string"==typeof a?this.form=q.querySelector(a):logError("Please pass a valid element or selector");b||(b=p);if("object"===typeof b)for(var c in p)"undefined"===typeof b[c]&&(b[c]=p[c]);this.config=b;this.errors={};this.validFields=[];this.init()}function r(a){return"object"===typeof HTMLElement?a instanceof HTMLElement:a&&"object"===typeof a&&null!==a&&1===a.nodeType&&"string"===typeof a.nodeName}function s(){this._thens=[]}var n=function(){},p={completed:n,
onFocus:n,onBlur:n,onKeyPress:n,fields:{}};h.prototype={onFieldFocus:function(a){var b=this,c=a.target;b.runLocalHandlers("validations",c).then(function(a){a&&0!=a.length||b.setFieldValid(c)});b.runLocalHandlers("onFocus",c,a)},onFieldBlur:function(a){var b=this,c=a.target;b.runLocalHandlers("validations",c).then(function(a){a&&0!=a.length?0<a.length&&b.setFieldInvalid(c,a):b.setFieldValid(c)});b.runLocalHandlers("onBlur",c,a)},onFieldKeyUp:function(a){var b=a.target;9!=(a.which||a.keyCode)&&(this.runValidationsDebounced(b),
this.runLocalHandlers("onKeyUp",b,a))},onFieldKeyPress:function(a){var b=a.target;this.runValidationsDebounced(b);this.runLocalHandlers("onKeyPress",b,a)},runValidationsDebounced:function(a,b){var c,d,f,e;return function(){f=this;d=[].slice.call(arguments,0);e=new Date;var g=function(){var k=new Date-e;k<b?c=setTimeout(g,b-k):(c=null,a.apply(f,d))};c||(c=setTimeout(g,b))}}(function(a){var b=this;b.runLocalHandlers("validations",a).then(function(c){c&&0<c.length?b.setFieldInvalid(a,c):b.setFieldValid(a)})},
1E3),setFieldInvalid:function(a,b,c){this.errors[a.name||a.id]=b;c=this.validFields.indexOf(a);-1<c&&this.validFields.splice(c,1);this.runLocalHandlers("onError",a,b)},setFieldValid:function(a){var b=this.config;this.runLocalHandlers("onValid",a);delete this.errors[a.name||a.id];-1==this.validFields.indexOf(a)&&this.validFields.push(a);this.isValid()&&b.completed(a)},getLocalHandlers:function(a){return this.handlers[this.fields.indexOf(a)]},runLocalHandlers:function(a,b,c){var d=new s,f=this.getLocalHandlers(b);
if("validations"==a)var e=[];for(var g,k=0;k<f.length;k++){var l=f[k];if("validations"==a){var m=null,h=function(a){e=e.concat(a);d.resolve(e)};"function"===typeof l?m=l(b,h):l[a]&&(m=l[a](b,h));"undefined"===typeof m?g=!0:m&&"[object Array]"===Object.prototype.toString.call(m)&&(e=e.concat(m));g||k!=f.length-1||d.resolve(e)}else if(l[a])l[a](b,c)}return d},isValid:function(a){if(a)return!this.errors.hasOwnProperty(a.id||a.name);if(this.validFields.length!==this.fields.length)return!1;for(var b in this.errors)if(this.errors.hasOwnProperty(b))return!1;
return!0},validate:function(a,b,c){var d=this,f=function(g){!0===b&&(g&&0!=g.length?0<g.length&&d.setFieldInvalid(c,g):d.setFieldValid(c));"function"===typeof a&&e==d.fields.length-1&&a(d.isValid())};if(c&&r(c)&&1<d.fields.indexOf(c))d.runLocalHandlers("validations",c).then(f);else for(var e=0;e<d.fields.length;e++)c=d.fields[e],d.runLocalHandlers("validations",c).then(f)},init:function(){var a=this;a.fields=[];a.handlers=[];for(var b in a.config.fields)for(var c=Array.prototype.slice.call((a.form||
q).querySelectorAll(b)),d=a.config.fields[b],f=0;f<c.length;f++){var e=c[f];-1==a.fields.indexOf(e)?(a.fields.push(e),a.handlers.push([d]),e.addEventListener("focus",function(b){a.onFieldFocus.call(a,b)}),e.addEventListener("blur",function(b){a.onFieldBlur.call(a,b)}),e.addEventListener("keypress",function(b){a.onFieldKeyPress.call(a,b)}),e.addEventListener("keyup",function(b){a.onFieldKeyUp.call(a,b)})):a.handlers[a.fields.indexOf(c[f])].push(d)}}};"function"==typeof define&&define.amd?define(function(){return h}):
"undefined"!==typeof module&&module.exports?module.exports=h:t.ThatValidator=h;s.prototype={then:function(a,b){this._thens.push({resolve:a,reject:b})},resolve:function(a){this._complete("resolve",a)},reject:function(a){this._complete("reject",a)},_complete:function(a,b){this.then="resolve"===a?function(a){a&&a(b)}:function(){throw Error("This promise has already been rejected");};for(var c,d=0;c=this._thens[d++];)c[a]&&c[a](b);delete this._thens}}})(window,document);
